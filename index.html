<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Ear Trainer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
            margin: 10px;
        }
        #playNoteBtn {
            background-color: #4CAF50;
            color: white;
        }
        #playNoteBtn:hover {
            background-color: #45a049;
        }
        #message {
            margin-top: 25px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 30px;
        }
        #currentPitch {
            font-size: 1.5em;
            margin-top: 15px;
            color: #3f51b5;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŽ¸ Guitar Ear Trainer</h1>

    <button id="playNoteBtn">Play a Note (Call)</button>

    <div id="message">
        Press "Play a Note" to begin.
    </div>

    <div id="currentPitch">
        Listening: OFF
    </div>
</div>

<script>
    // --- Configuration ---
    const NOTE_FREQUENCIES = {
        'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 
        'F#3': 184.99, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 
        'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88
    };
    const NOTE_NAMES = Object.keys(NOTE_FREQUENCIES);
    
    let audioContext;
    let microphoneStream;
    let analyserNode;
    let isListening = false;
    let targetNoteName = null;
    let targetFrequency = 0;
    
    // Elements
    const playNoteBtn = document.getElementById('playNoteBtn');
    const messageEl = document.getElementById('message');
    const currentPitchEl = document.getElementById('currentPitch');

    // --- Core Pitch Detection Logic (Simplified Autocorrelation) ---
    function getPitch(buffer, sampleRate) {
        // Find the maximum value in the buffer
        let maxVal = 0;
        for (let i = 0; i < buffer.length; i++) {
            if (Math.abs(buffer[i]) > maxVal) maxVal = Math.abs(buffer[i]);
        }
        // Simple threshold check to ignore silence/noise
        if (maxVal < 0.1) return 0; 

        // Autocorrelation algorithm (ACF) to find the period of the wave
        let best_offset = -1;
        let best_correlation = -1;
        let correlation_threshold = 0.9; // Adjust this for sensitivity

        for (let offset = 1; offset < buffer.length / 2; offset++) {
            let correlation = 0;
            for (let i = 0; i < buffer.length - offset; i++) {
                correlation += buffer[i] * buffer[i + offset];
            }
            if (correlation > best_correlation) {
                best_correlation = correlation;
                best_offset = offset;
            }
        }
        
        // Convert offset (period) to frequency
        if (best_correlation > correlation_threshold) {
            return sampleRate / best_offset;
        }
        return 0; // Return 0 if no clear pitch is found
    }

    // --- Audio Utility Functions ---
    function frequencyToNote(frequency) {
        if (frequency === 0) return '---';

        // Reference A4 = 440Hz
        const A4_FREQ = 440;
        const A4_MIDI = 69;
        
        // Calculate MIDI note number (n = 12 * log2(f/440) + 69)
        const midiNote = Math.round(12 * (Math.log(frequency / A4_FREQ) / Math.log(2))) + A4_MIDI;
        
        // Map MIDI number to note name (A0, A#0, B0, C1, ...)
        const noteIndex = (midiNote % 12);
        const octave = Math.floor(midiNote / 12) - 1;
        
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        return noteNames[(noteIndex + 3) % 12] + octave; // +3 because C is at index 0
    }
    
    function playTone(frequency) {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.type = 'sine'; // Pure tone
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); // Volume

        oscillator.start();
        
        // Stop after 1 second
        oscillator.stop(audioContext.currentTime + 1.0);
    }
    
    // --- Game Logic ---
    async function startListening() {
        if (isListening) return;

        messageEl.textContent = "Listening... Play your note now!";
        currentPitchEl.textContent = 'Listening: ON';

        try {
            // Request microphone access
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            microphoneStream = stream;
            
            const source = audioContext.createMediaStreamSource(stream);
            analyserNode = audioContext.createAnalyser();
            
            // Configure analyser for pitch detection
            analyserNode.fftSize = 2048;
            source.connect(analyserNode);
            
            const bufferLength = analyserNode.fftSize;
            const buffer = new Float32Array(bufferLength);
            
            isListening = true;
            
            function updatePitch() {
                if (!isListening) return;

                analyserNode.getFloatTimeDomainData(buffer);
                const detectedFrequency = getPitch(buffer, audioContext.sampleRate);
                const detectedNote = frequencyToNote(detectedFrequency);

                currentPitchEl.textContent = detectedNote !== '---' 
                    ? `You played: ${detectedNote}`
                    : `You played: --- (No clear note)`;

                // Check for a match only if a clear pitch is detected
                if (detectedNote !== '---' && targetNoteName) {
                    if (detectedNote === targetNoteName) {
                        messageEl.style.color = 'green';
                        messageEl.textContent = `CORRECT! You played ${detectedNote}!`;
                        stopListening(true);
                        return;
                    }
                }
                
                requestAnimationFrame(updatePitch);
            }
            updatePitch();

        } catch (err) {
            messageEl.style.color = 'red';
            messageEl.textContent = 'Microphone access denied or error: ' + err.name;
            isListening = false;
        }
    }

    function stopListening(wasCorrect) {
        isListening = false;
        targetNoteName = null;
        currentPitchEl.textContent = 'Listening: OFF';
        
        // Stop microphone tracks
        if (microphoneStream) {
            microphoneStream.getTracks().forEach(track => track.stop());
            microphoneStream = null;
        }

        // Prepare for the next round
        if (!wasCorrect) {
            messageEl.style.color = 'red';
            messageEl.textContent = `INCORRECT or Timeout. The note was ${targetNoteName}. Press "Play a Note" to try again.`;
        }
    }

    // --- Event Listener ---
    playNoteBtn.addEventListener('click', async () => {
        // Initialize AudioContext on first user interaction
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // Select a random target note from C3 to B4
        const randomIndex = Math.floor(Math.random() * NOTE_NAMES.length);
        targetNoteName = NOTE_NAMES[randomIndex];
        targetFrequency = NOTE_FREQUENCIES[targetNoteName];

        messageEl.style.color = '#333';
        messageEl.textContent = `Playing ${targetNoteName}... Listen carefully!`;
        
        // 1. Call: Play the note
        playTone(targetFrequency);

        // 2. Wait 1.5 seconds, then start listening for response
        setTimeout(() => {
            messageEl.style.color = '#0056b3';
            startListening();
        }, 1500);

        // 3. Timeout for the response (e.g., 5 seconds to play the note)
        setTimeout(() => {
            if (isListening) {
                stopListening(false);
            }
        }, 6500); // 1.5s (wait) + 5s (response window)
    });
    
</script>

</body>
</html>
